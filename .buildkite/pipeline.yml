env:
  BUILD_DIR: "/build/decentralized-software-updates"
  STACK_ROOT: "/build/decentralized-software-updates.stack"
  CACHE_DIR: "/cache/decentralized-software-updates"

steps:
  - label: 'stack coveralls coverage'
    command:
      - 'nix-shell -A runCoveralls'
    agents:
      system: x86_64-linux

  - label: Stack build
    command:
      - "nix-build .buildkite/default.nix -o sr"
      - "./sr/bin/rebuild --build-dir=$BUILD_DIR --cache-dir=$CACHE_DIR"
    agents:
      system: x86_64-linux
    timeout_in_minutes: 60
    artifact_paths:
      - "/build/decentralized-software-updates/.stack-work/logs/decentralized-software-updates*.log"

  - label: 'check-cabal-project'
    command: 'nix-build ./nix -A iohkNix.checkCabalProject -o check-cabal-project.sh && ./check-cabal-project.sh'
    agents:
      system: x86_64-linux

# FIXME, waiting for https://github.com/input-output-hk/haskell.nix/pull/426
#  - label: 'release.nix'
#    command: 'nix-build -A check-hydra -o check-hydra.sh && ./check-hydra.sh'
#    agents:
#      system: x86_64-linux

  - label: 'stack-cabal-sync'
    command: 'nix-shell ./nix -A iohkNix.stack-cabal-sync-shell --run scripts/buildkite/stack-cabal-sync.sh'
    agents:
      system: x86_64-linux

  - label: 'stack2nix'
    command: 'ci/check-regenerate-nix.sh'
    agents:
      system: x86_64-linux

